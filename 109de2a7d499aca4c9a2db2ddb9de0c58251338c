Revision: 109de2a7d499aca4c9a2db2ddb9de0c58251338c
Patch-set: 1
File: media/libstagefright/FLACExtractor.cpp

861
Tue Dec 15 17:32:15 2015 +0000
Author: Marco Nelissen <1001525@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 85d9c240_28ef0aab
Bytes: 495
The id3 spec says:

"An ID3v2 tag can be detected with the following pattern:
$49 44 33 yy yy xx zz zz zz zz
Where yy is less than $FF, xx is the 'flags' byte and zz is less than $80."

so it might be a good idea to check those yy and zz bytes in addition to the three leading 'ID3' bytes.

Also note that id3v2.4 defines an optional footer at the end of the tag, which is not included in the size. So if the version is 2.4, and the footer-flag is set, another sizeof(id3header) should be added.

861
Wed Dec 16 15:52:50 2015 +0000
Author: John Eckerdal <1037953@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 85d9c240_28ef0aab
UUID: 85b2a2f4_fdeebfac
Bytes: 328
Will look into updating the commit.

However please note that the current upload brings it more in line with how the reference sniffer in external/flac/libFLAC/metadata_iterators.c handles ID3v2 tags. By adding additional checks on the file would make Android more strict than the reference sniffer.
Is this wanted and expected?

861
Wed Dec 16 16:23:38 2015 +0000
Author: Marco Nelissen <1001525@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 85b2a2f4_fdeebfac
UUID: 455a6ade_a529be7a
Bytes: 816
It can be argued both ways. I expect the reference implementation to fail on id3v2.4 files with footer (because it will end up at the wrong offset in the file). Making the change I suggested would make it work with such files. On the other hand, we'd be less forgiving with files that are technically in violation of the spec, whereas the reference parser would accept those anyway.

Note that the id3 parser at frameworks/av/media/libstagefright/id3/ID3.cpp doesn't deal with footers either, but it does check that the version fields are valid.

Perhaps a compromise here could be to check the version and flags, but only specifically for v2.4+footer. That way flac files that specify the id3 version wrong would still be accepted, while files that correctly specify the version and footer flag could be parsed too.

